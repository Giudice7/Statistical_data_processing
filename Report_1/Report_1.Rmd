---
title: "Multiple linear regression for energy consumption data"
author: "Rocco Giudice"
date: "2023-03-31"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo=FALSE, include=FALSE}
library(DT)
library(plotly)
library(ggplot2)
Sys.setlocale("LC_ALL", "English")
```


### Introduction

Energy consumption is a critical concern worldwide due to its impact on the environment, economy, and human welfare. Therefore, understanding the factors that influence energy consumption in buildings is essential to optimize energy use and minimize its negative effects. Multiple linear regression is a statistical method used to model the relationship between a dependent variable and several independent variables simultaneously. In this report, we perform a multiple linear regression analysis to investigate the factors that affect energy consumption. The analysis is based on a dataset that includes information on natural gas consumption and several variables related to weather conditions (such as the mean external temperature and the irradiance). The objective of this study is to identify the significant predictors of energy consumption and provide insights into the underlying mechanisms that drive energy use.

The report is organized in the following sections:

* Dataset: ...
* Outlier detection: ...
* Multiple linear regression model: ...
* Conclusion: ...

### Dataset 

The dataset utilized in this analysis is composed by 3 numerical variables, total daily gas consumption *Energy* $[Smc]$, mean daily external temperature *Text* $[°C]$, and mean solar irradiance *Iext* $[W/m^2]$ and 1 categorical variable, the day of the week *DayofWeek*. 

The dataset provides daily measurements of these variables for a full heating season in Turin, which goes from $1^{st}$ November to $31^{th}$ March, resulting in a total of 151 records.

In the table below is reported a sketch of the dataset.

```{r, echo=FALSE}
data <- read.csv(file = file.path("data", "energy_data.csv"),
                sep = ";") 

DT::datatable(data)

```

The trend of the variables during the heating season is represented in the figure below.

```{r, echo=FALSE}

# Reformat data in order to transform variable from character to numeric
data <- data %>%
  mutate(
    date = as.Date(date),
    Energy = round(as.numeric(gsub(",", ".", Energy)), digits = 2),
    Text = round(as.numeric(gsub(",", ".", Text)), digits = 2),
    Iext = round(as.numeric(gsub(",", ".", Iext)), digits = 2),
    day_name = weekdays(as.Date(data$date)))

```

<center>
```{r, echo=FALSE, fig.height=4}

# Gas consumption time series
plot_ly(data = data,
        type = "scatter",
        mode = "lines",
        x = ~date,
        y = ~Energy,
        text = ~day_name,
        hovertemplate = paste('<b>Date</b>: %{x}',
                        '<br><b>Gas consumption</b>: %{y} [Smc]<br>',
                        '<b>Weekday</b>: %{text}',
                          "<extra></extra>"),
        line = list(
          color = "#1EB962"
        )) %>%
  layout(
    title = "Gas consumption time-series",
    xaxis = list(
      title = "Date"
    ),
    yaxis = list(
      title = "Gas consumption [Smc]"
    )
  )

# External temperature time series
plot_ly(data = data,
        type = "scatter",
        mode = "lines",
        x = ~date,
        y = ~Text,
        text = ~day_name,
        hovertemplate = paste('<b>Date</b>: %{x}',
                        '<br><b>Temperature</b>: %{y} [°C]<br>',
                        '<b>Weekday</b>: %{text}',
                          "<extra></extra>"),
        line = list(
          color = "#CF0000"
        )) %>%
  layout(
    title = "Mean daily external temperature time-series",
    xaxis = list(
      title = "Date"
    ),
    yaxis = list(
      title = "Temperature [°C]"
    )
  )

# Irradiance time series
plot_ly(data = data,
        type = "scatter",
        mode = "lines",
        x = ~date,
        y = ~Iext,
        text = ~day_name,
        hovertemplate = paste('<b>Date</b>: %{x}',
                        '<br><b>Irradiance</b>: %{y} [W/m2]<br>',
                        '<b>Weekday</b>: %{text}',
                          "<extra></extra>"),
        line = list(
          color = "#CFA000"
        )) %>%
  layout(
    title = "Mean daily external temperature time-series",
    xaxis = list(
      title = "Date"
    ),
    yaxis = list(
      title = "Irradiance [W/m2]"
    )
  )

```
</center>

Will be useful for the further steps to summarize the dataset in terms of statistical quantities and distributions:

```{r, echo=FALSE}
summary(data)
```


<center>
```{r, echo=FALSE, fig.width=10}

density_energy <- density(data$Energy) 

dens_energy <- plot_ly(
  x = ~density_energy$x,
  y = ~density_energy$y,
  type = 'scatter', mode = 'lines', fill = 'tozeroy',
  line = list(
    color = "#1EB962"
  ),
  fillcolor = "rgba(30, 185, 98, 0.5)",
  hovertemplate = paste('<b>Energy</b>: %{x} [Smc]',
                        '<br><b>Density</b>: %{y}<br>'
  )
) %>%
  layout(
    xaxis = list(
      title = "Gas consumption [Smc]",
      range = c(0, max(data$Energy))
    ),
    yaxis = list(
      showticklabels = FALSE
    )
  )

boxplot_energy <- plot_ly(
  type = "box",
  data = data,
  x = ~Energy,
  jitter = 0.3,
  line = list(
    color = "#1EB962"
  ),
  fillcolor = "rgba(30, 185, 98, 0.5)",
  name = "Energy"
    ) %>%
  layout(
    yaxis = list(
      showticklabels = FALSE
    )
  )


plot_energy <- subplot(dens_energy, boxplot_energy, nrows = 2, heights = c(0.7, 0.3),
                       shareX = TRUE) %>%
  layout(
    showlegend = FALSE,
    xaxis = list(
      title = "Gas consumption [Smc]"
    )
  )

density_Text <- density(data$Text) 

dens_Text <- plot_ly(
  x = ~density_Text$x,
  y = ~density_Text$y,
  type = 'scatter', mode = 'lines', fill = 'tozeroy',
  line = list(
    color = "#CF0000"
  ),
  fillcolor = "rgba(207, 0, 0, 0.5)",
  hovertemplate = paste('<b>Temperature</b>: %{x} [°C]',
                        '<br><b>Density</b>: %{y}<br>'
  )
) %>%
  layout(
    xaxis = list(
      title = "Temperature [°C]",
      range = c(min(data$Text), max(data$Text))
    ),
    yaxis = list(
      showticklabels = FALSE
    )
  )

boxplot_Text <- plot_ly(
  type = "box",
  data = data,
  x = ~Text,
  jitter = 0.3,
  line = list(
    color = "#CF0000"
  ),
  name = "Text",
  fillcolor = "rgba(207, 0, 0, 0.5)"
    ) %>%
  layout(
    yaxis = list(
      showticklabels = FALSE
    )
  )

plot_Text <- subplot(dens_Text, boxplot_Text, nrows = 2, heights = c(0.7, 0.3),
                       shareX = TRUE) %>%
  layout(
    showlegend = FALSE,
    xaxis = list(
      title = "Temperature [°C]"
    )
  )

density_Iext <- density(data$Iext) 

dens_Iext <- plot_ly(
  x = ~density_Iext$x,
  y = ~density_Iext$y,
  type = 'scatter', mode = 'lines', fill = 'tozeroy',
  line = list(
    color = "#CFA000"
  ),
  fillcolor = "rgba(207, 160, 0, 0.5)",
  hovertemplate = paste('<b>Irradiance</b>: %{x} [W/m2]',
                        '<br><b>Density</b>: %{y}<br>'
  )
) %>%
  layout(
    xaxis = list(
      title = "Irradiance [W/m2]",
      range = c(min(data$Iext), max(data$Iext))
    ),
    yaxis = list(
      showticklabels = FALSE
    )
  )

boxplot_Iext <- plot_ly(
  type = "box",
  data = data,
  x = ~Iext,
  jitter = 0.3,
  line = list(
    color = "#CFA000"
  ),
  fillcolor = "rgba(207, 160, 0, 0.5)",
  name = "Iext"
    ) %>%
  layout(
    yaxis = list(
      showticklabels = FALSE
    )
  )

plot_Iext <- subplot(dens_Iext, boxplot_Iext, nrows = 2, heights = c(0.7, 0.3),
                       shareX = TRUE) %>%
  layout(
    showlegend = FALSE,
    xaxis = list(
      title = "Irradiance [W/m2]"
    )
  )

plot_distr <- subplot(plot_energy, plot_Text, plot_Iext, nrows = 1, titleX = TRUE) 
plot_distr
```
</center>

### Outlier detection

In this section, an outlier detection process is employed with the aim to identify possible values of the variables analyzed that can be consider far enough from the distribution of data and that can lead to incorrect or misleading conclusions when developing a multiple regression model. 

In this case one way to operate could be the use of the Cook's distance, which is a measure of the influence of each observation on a regression analysis. It can be used to identify multivariate outliers in non-normal distributions, like ours, by examining the values of Cook's distance for each observation. Large values of Cook's distance indicate observations that are having a disproportionate influence on the regression analysis, which could be due to being outliers.

Cook's distance is evaluated as:

$$D_i = \frac{\sum_{j=1}^n (\hat{y_j} - \hat{y_{j(i)}})}{ps^2}$$
where $\hat{y_j}$ is the predition of the mean using the j observation and $\hat{y_{j(i)}}$ is the prediction of the mean without the i-observation, $s^2$ is the mean square error and $p$ is the number of independent variables.

To better visualize the dataset, a 3D scatter plot is reported in the figure below, coloring in different ways the $DayoftheWeek$.

<center>
```{r, echo=FALSE, fig.width=10, warning=FALSE, message=FALSE}
scatter_3D <- plot_ly(type = "scatter3d",
               data = data,
               x = ~Text, y = ~Iext, z = ~Energy,
               color = ~day_name, 
               text = ~date,
               colors = c("#fde725", "#90d743", "#35b779", "#21918c", "#31688e", "#443983", "#440154"),
               hovertemplate = paste("<b>Temperature: %{x} [°C]",
                                     '<br><b>Irradiance</b>: %{y} [W/m2]<br>',
                                     '<b>Gas consumption</b>: %{z} [Smc]',
                                     '<br><b>Date</b>: %{text}<br>',
                                     "<extra></extra>")
) %>%
  layout(legend = list(orientation = "h"),
         scene = list(
           xaxis = list(
             title = "Temperature [°C]"
           ),
           yaxis = list(
             title = "Irradiance [W/m2]"
           ),
           zaxis = list(
             title = "Gas consumption [Smc]"
           )
         )
  )

scatter_3D
```
</center>

As we can easily seen, Sundays are day of the week where there is no energy consumption, so can be easily eliminated from the model to improve the accuracy. 

```{r, echo=FALSE}
data_model <- data %>%
  subset(day_name != "Sunday")
rownames(data_model) <- 1:nrow(data_model)
```

Now we can perform the model and evaluate the Cook's distance:

```{r, echo=FALSE}
model <- lm(Energy ~ Text + Iext, data = data_model)
# summary(model)
data_model$distance_cooks <- cooks.distance(model)
DT::datatable(data_model[, c("date", "day_name", "Energy", "Text", "Iext", "distance_cooks")])
```

A thumb's rule using the Cook's distance to outlier detection is considering a threshold value of $4/n$, where $n$ is the number of observations (130). So, records with Cook's distance higher than $0.031$ are considered outliers and eliminated from the model to make it more accurate.

Let's plot the Cook's distances and the threshold identified:

<center>
```{r, echo=FALSE, fig.width=10, message=FALSE}
threshold <- 4/length(rownames(data_model))

cooks_plot <- plot_ly(
  type = "scatter",
  data = data_model,
  x = c(1:length(rownames(data_model))),
  y =~ round(distance_cooks, 5),
  text =~ date,
  hovertemplate = paste('<br><b>Cook s distance</b>: %{y}<br>',
                        '<b>Date</b>: %{text}',
                          "<extra></extra>"),
  name = ""
) %>%
  add_trace(
    type = "scatter",
    mode = "lines",
    x = c(1:length(rownames(data_model))),
    y = rep(x = threshold, 
            times = length(rownames(data_model))),
    hovertemplate = paste("Threshold: %{y}",
                          "<extra></extra>")
  ) %>%
  layout(title = "Cook's distance plot",
         xaxis = list(
           title = "Index"
         ),
         yaxis = list(
           title = "Cook's distance"
         ),
         showlegend = FALSE
  )
  
cooks_plot

outliers_date <- data_model$date[data_model$distance_cooks >= threshold]
```
</center>

How we can see, 4 outliers have been identified using this metric, which are `r outliers_date`.

Now we can eliminate these data and re-perform the linear regression model, evaluating its performance.

### Multiple regression model
